<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>DMC Full Stack Test</title>

        <script type="text/javascript" src="./static/lib/d3.js"></script>
  		<script type="text/javascript" src="./static/lib/queue.js"></script>
  		<link rel="stylesheet" href="./static/lib/leaflet.css" />
  		<script type="text/javascript" src="./static/lib/leaflet.js"></script>

  		<style>
  			@import url(http://fonts.googleapis.com/css?family=Roboto:300,500);
			body {
				padding: 0;
				margin: 0;
				font-family: Roboto, Helvetica, Arial, sans-serif;
				font-size: 12px;
				line-height: 18px;
				font-weight: 300;
			}
			h1,
			h2,
			h3,
			h4,
			h5,
			h6 {
				margin: .4em 0 .4em;
			    font-weight: 500;
			}
			h4{	
				background-color: yellow;
				font-size: 1.5em;
			}
			html, body, #map {
				height: 100%;
			}
			div.fixed {
				position: fixed;
				margin: 0px;
				padding: 10px;
				top: 0px;
				right: 0px;
				width: 266px;
				height: 400px;
    			/*border: 3px solid #8AC007;*/
    			background: rgba(255,255,255,.8);
			}
			p.footer{
				position: absolute;
				bottom: 10px;
				margin: 0;
			}

			svg {
			  position: relative;
			}

			path {
			  fill: #000;
			  fill-opacity: .2;
			  stroke: #fff;
			  stroke-width: 1.5px;
			}

			circle {
			  fill: orange;
			  fill-opacity: .2;
			  stroke: grey;
			  stroke-width: 1px;
			}

			path:hover {
			  fill: brown;
			  fill-opacity: .7;
			}

		</style>

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    </head>
    <body>

    	<!-- map container -->
    	<div id="map"></div>

    	<!-- fixed HUD -->
    	<div class="fixed">
    		<h4>DMC Web Stack Demo</h4>
    		<p>Interactive map using data scraped from htpp://www.fang.com.</p>
    		<p class="footer">&copy;2015 Danil Nagy</p>
    		<input name="updateButton" 
           		type="button" 
           		value="Update Random Data" 
           		onclick="updateData()" />
           	</div>

    	<script type="text/javascript">
    	
    		var map = L.map('map').setView([39.907236, 116.401079], 15);

    		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    		maxZoom: 18,
    		id: 'danilnagy.7dba0108',
    		accessToken: 'pk.eyJ1IjoiZGFuaWxuYWd5IiwiYSI6ImVobm1tZWsifQ.CGQL9qrfNzMYtaQMiI-c8A'
			}).addTo(map);

			var svg = d3.select(map.getPanes().overlayPane).append("svg"),
				g = svg.append("g").attr("class", "leaflet-zoom-hide");

			// Use Leaflet to implement a D3 geometric transformation.
				function projectPoint(x, y) {
					var point = map.latLngToLayerPoint(new L.LatLng(y, x));
					this.stream.point(point.x, point.y);
				}

				function latlngPoint(x, y) {
					return map.latLngToLayerPoint(new L.LatLng(x, y));
				}

			// call python function to query data
			d3.json("/listings?lat=39.907236&lon=116.401079", function(data) {
				var transform = d3.geo.transform({point: projectPoint}),
					path = d3.geo.path().projection(transform);

				var feature = g.selectAll("path")
					.data(data.features)
					.enter().append("circle");

				  map.on("viewreset", reset);
				  reset();

				  // Reposition the SVG to cover the features.
				  function reset() {
				    var bounds = path.bounds(data),
				        topLeft = bounds[0],
				        bottomRight = bounds[1];

				    svg .attr("width", bottomRight[0] - topLeft[0] + 500)
				        .attr("height", bottomRight[1] - topLeft[1] + 500)
				        .style("left", (topLeft[0] - 250) + "px")
				        .style("top", (topLeft[1] - 250) + "px");

				    g   .attr("transform", "translate(" + (-topLeft[0] + 250) + "," + (-topLeft[1] + 250) + ")");

				    feature
				    	.attr("cx", function(d) { return latlngPoint(d.geometry.coordinates[1], d.geometry.coordinates[0]).x; })
				    	.attr("cy", function(d) { return latlngPoint(d.geometry.coordinates[1], d.geometry.coordinates[0]).y; })
				    	.attr("r", function(d) { return Math.pow(d.properties.price,.3); });
				  }

				

			});

			function updateData() {

				d3.json("/listings?lat=39.907236&lon=116.411079", function(data) {
				  	console.log(data)

					var transform = d3.geo.transform({point: projectPoint}),
					path = d3.geo.path().projection(transform);

					var feature = g.selectAll("circle")
					.data(data.features);

				  map.on("viewreset", reset);
				  reset();


				  // Reposition the SVG to cover the features.
				  function reset() {
				    var bounds = path.bounds(data),
				        topLeft = bounds[0],
				        bottomRight = bounds[1];

				    console.log(bounds)

				    svg .attr("width", bottomRight[0] - topLeft[0] + 500)
				        .attr("height", bottomRight[1] - topLeft[1] + 500)
				        .style("left", (topLeft[0] - 250) + "px")
				        .style("top", (topLeft[1] - 250) + "px");

				    g   .attr("transform", "translate(" + (-topLeft[0] + 250) + "," + (-topLeft[1] + 250) + ")");

				    feature
				    	.attr("cx", function(d) { return latlngPoint(d.geometry.coordinates[1], d.geometry.coordinates[0]).x; })
				    	.attr("cy", function(d) { return latlngPoint(d.geometry.coordinates[1], d.geometry.coordinates[0]).y; })
				    	.attr("r", function(d) { return Math.pow(d.properties.price,.3); });
				  }


				});

				// var svg = d3.select("body");
				// svg.selectAll("circle")
				// 	.style("fill", "black");
			}


        </script>

    </body>
</html>  